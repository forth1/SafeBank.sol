<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Event Listener Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
</head>
<body style="background:#111; color:#fff; font-family:Arial; padding:20px;">

<h2>Event Listener Demo</h2>

<button id="connect">è¿æ¥é’±åŒ…</button>

<p>å½“å‰è´¦å·ï¼š<span id="addr">æœªè¿æ¥</span></p >
<hr>
<p>æœ€æ–°äº‹ä»¶ï¼š<span id="lastEvent">æš‚æ— </span></p >

<script>
  // ä½ çš„åˆçº¦åœ°å€ï¼ˆBase Sepolia ä¸Š Lesson8_EventsBankï¼‰
  const CONTRACT_ADDRESS = "0xCFFE24918BB30638D135C326c78Ab217A59d565c";

  // ä½ çš„ ABIï¼ˆè¿™é‡Œåªä¿ç•™ç”¨åˆ°çš„å‡½æ•°å’Œäº‹ä»¶ï¼‰
  const ABI = [
    {
      "inputs": [],
      "name": "deposit",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function"
    },
    {
      "anonymous": false,
      "inputs": [
        { "indexed": true,  "internalType": "address", "name": "user",   "type": "address" },
        { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
      ],
      "name": "Deposit",
      "type": "event"
    },
    {
      "inputs": [
        { "internalType": "uint256", "name": "amount", "type": "uint256" }
      ],
      "name": "withdraw",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "anonymous": false,
      "inputs": [
        { "indexed": true,  "internalType": "address", "name": "user",   "type": "address" },
        { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
      ],
      "name": "Withdraw",
      "type": "event"
    },
    {
      "inputs": [
        { "internalType": "address", "name": "", "type": "address" }
      ],
      "name": "balances",
      "outputs": [
        { "internalType": "uint256", "name": "", "type": "uint256" }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ];

  let provider, signer, contract;

  const addrSpan  = document.getElementById("addr");
  const eventSpan = document.getElementById("lastEvent");

  document.getElementById("connect").onclick = async () => {
    try {
      if (!window.ethereum) {
        alert("æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·å…ˆå®‰è£… OKX / MetaMask ç­‰æµè§ˆå™¨é’±åŒ…æ‰©å±•ã€‚");
        return;
      }

      // 1. è¿æ¥é’±åŒ…
      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      const addr = await signer.getAddress();
      addrSpan.textContent = addr;

      const network = await provider.getNetwork();
      console.log("å½“å‰ç½‘ç»œï¼š", network);
      // ä½ ç°åœ¨ç”¨ Base Sepolia å°±è¡Œï¼Œå¦‚æœä¸æ˜¯ 84532 è¯´æ˜é’±åŒ…ç½‘ç»œä¸å¯¹
      // if (Number(network.chainId) !== 84532) { ... } // éœ€è¦å¯ä»¥å†åŠ æ£€æŸ¥

      // 2. è¿æ¥åˆçº¦
      contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

      // å…ˆæŠŠæ—§ç›‘å¬æ¸…æ‰ï¼Œé¿å…é‡å¤
      contract.removeAllListeners();

      // 3. ç›‘å¬å­˜æ¬¾äº‹ä»¶
      contract.on("Deposit", (user, amount, event) => {
        console.log("ğŸ“¥ Deposit äº‹ä»¶è§¦å‘", { user, amount: amount.toString(), event });
        const msg = `å­˜æ¬¾äº‹ä»¶ï¼š${user} å­˜å…¥äº† ${amount.toString()} wei`;
        eventSpan.textContent = msg;
        alert(msg);
      });

      // 4. ç›‘å¬å–æ¬¾äº‹ä»¶
      contract.on("Withdraw", (user, amount, event) => {
        console.log("ğŸ“¤ Withdraw äº‹ä»¶è§¦å‘", { user, amount: amount.toString(), event });
        const msg = `å–æ¬¾äº‹ä»¶ï¼š${user} å–å‡ºäº† ${amount.toString()} wei`;
        eventSpan.textContent = msg;
        alert(msg);
      });

      alert("âœ… é’±åŒ…å·²è¿æ¥ï¼Œäº‹ä»¶ç›‘å¬å·²å¯åŠ¨ï¼");
    } catch (err) {
      console.error("è¿æ¥æˆ–ç›‘å¬æ—¶å‡ºé”™ï¼š", err);
      alert("è¿æ¥æˆ–ç›‘å¬å¤±è´¥ï¼Œè¯·æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ã€‚");
    }
  };
</script>

</body>
</html>
